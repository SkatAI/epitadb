# worksheet on functions

## Context

Goal: each tree has a corresponding unique HASH string

- we  use existing sha256 function and work on the `treesdb_v03` (fully normalized)

## tasks

- write a SQL query that concatenates all categorical columns : name, domain, genre, species, variety, arrondissement,
  - replace the NULL value by 'UNK' using COALESCE
- extend the function so that it uses the concatenated string as input to sha256 and return the sha256 hash string
- write a simple SQL function built on that query that returns the hash given a tree id
- add a column in the trees db as `sha_id`: text
- rewrite that function to add
  - insert the hash string into a sha256 column
  - handle exception handling
- run the function on several rows
- modify the function to handle a whole subset of trees and not just one

add a constraint that code needs to be unique

- write a pl/pgsql function that runs the sha on all the rows
- insert the sha value in the `sha_id` column
- add check that the tree does not exist already

## Uniqueness

Do we have duplicate sha_ids ?

What do we need to do so that the uniqueness of the sha_id tells us about the uniqueness of trees ?

Let's add gelocation to the concatenate string
drop the column sha_id and recreate it with a UNIQUE constraint

Use ... in the function ... to raise notice and avoid adding sha_id for duplicates
