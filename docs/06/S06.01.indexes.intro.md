# Session 6

## Last time

We saw

- an important concept: in a relational database everything (mostly) is a **relation**
- how the query optimizer works: plan, chooses algorithms, executes
- the cost function the planner tries to minimize : weights * f(CPU + I/0)
- the structure of an explain plan : children and parent nodes
- difference between EXPLAIN and EXPLAIN ANALYZE : cost estimation or execute the query
- how to EXPLAIN ANALYZE update, insert and delete queries with BEGIN ... END;
- several types of algorithms for scanning data
  - sequential scans
  - bitmap scans
  - index scans

## Precisions on Explain and scans

- let's go back on the Bitmap Heap and Bitmap Index Scans
- An actually show the difference between EXPLAIN and EXPLAIN ANALYZE
- how to update the stats on a table. EXPLAIN ANALYZE does not force the real stats on the planner. Instead, it shows you both the planner's estimates and what actually happened during execution.
- ANALYZE a table to update the stats

## On the menu for today

- indexes
  - how to create them
  - when they are applied
  - B-tree indexes and Hash Indexes
- a small quiz on the algorithms we've seen so far
- practice on a new entirely made up dataset of energy sources using a PL/SQL function

## EOD

- knowing when to add an index to speed up a slow query
- difference between Hash and B-Tree indexes
- factors impacting the efficiency of an index

-----

You're correct that EXPLAIN ANALYZE does provide real statistics about the query execution. However, there's an important distinction to make:

1. Query Planning Phase:
   - This happens before the query is actually executed.
   - The planner uses statistics gathered about the table and indexes to estimate the number of rows that will be returned.
   - These statistics are not real-time and are based on data collected during routine database maintenance (like ANALYZE operations).

2. Query Execution Phase:
   - This is when the query is actually run and ANALYZE collects real-time data.
   - The actual number of rows processed is determined here.

EXPLAIN ANALYZE shows both the estimated values (from the planning phase) and the actual values (from the execution phase). That's why you see both cost estimates (which include row estimates) and actual time and row counts in the output.

So, to answer your specific question:

The row estimation being off by a factor of 2 (957 estimated vs 1955 actual) is coming from the planning phase. EXPLAIN ANALYZE doesn't force the planner to use real stats for its estimates. Instead, it shows you both the planner's estimates and what actually happened during execution.

This discrepancy can occur for several reasons:

1. Outdated statistics: If the table statistics haven't been updated recently, they might not reflect the current data distribution.

2. Correlation between columns: The planner might not fully account for correlations between columns when making estimates.

3. Uniform distribution assumption: For some types of estimates, the planner might assume a more uniform distribution of data than actually exists.

4. Limitations in the statistical model: The planner uses a simplified model to make quick estimates, which can sometimes be inaccurate for certain data distributions.

To improve these estimates, you could try:

1. Running ANALYZE on the table to update its statistics.
2. Increasing the statistics target for the column (e.g., ALTER TABLE booking ALTER COLUMN phone SET STATISTICS 1000;)
3. In some cases, using an extension like pg_stat_statements to gather more detailed statistics over time.

Remember, while accurate estimates are helpful for query planning, some level of inaccuracy is normal and often doesn't significantly impact performance, especially for simpler queries. The planner's primary goal is to choose a good execution plan, which it seems to have done in this case despite the estimation discrepancy.
